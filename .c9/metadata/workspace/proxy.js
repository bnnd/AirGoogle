{"filter":false,"title":"proxy.js","tooltip":"/proxy.js","undoManager":{"mark":83,"position":83,"stack":[[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":0},"end":{"row":4,"column":1}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":1},"end":{"row":4,"column":2}},"text":"*"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":2},"end":{"row":4,"column":3}},"text":"*"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":3},"end":{"row":4,"column":4}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":3},"end":{"row":4,"column":4}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":2},"end":{"row":4,"column":3}},"text":"*"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":1},"end":{"row":4,"column":2}},"text":"*"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":0},"end":{"row":4,"column":1}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":0},"end":{"row":4,"column":1}},"text":"?"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":1},"end":{"row":4,"column":2}},"text":"8"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":2},"end":{"row":4,"column":3}},"text":"8"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":4,"column":3},"end":{"row":4,"column":4}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":3},"end":{"row":4,"column":4}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":2},"end":{"row":4,"column":3}},"text":"8"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":1},"end":{"row":4,"column":2}},"text":"8"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":4,"column":0},"end":{"row":4,"column":1}},"text":"?"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":53},"end":{"row":83,"column":56}},"text":"   "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":56},"end":{"row":83,"column":57}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":57},"end":{"row":83,"column":58}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":58},"end":{"row":83,"column":60}},"text":"防止"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":58},"end":{"row":83,"column":59}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":61},"end":{"row":83,"column":62}},"text":"x"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":62},"end":{"row":83,"column":63}},"text":"-"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":63},"end":{"row":83,"column":64}},"text":"f"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":64},"end":{"row":83,"column":65}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":65},"end":{"row":83,"column":66}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":66},"end":{"row":83,"column":67}},"text":"w"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":67},"end":{"row":83,"column":68}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":68},"end":{"row":83,"column":69}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":69},"end":{"row":83,"column":70}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":70},"end":{"row":83,"column":71}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":71},"end":{"row":83,"column":72}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":72},"end":{"row":83,"column":73}},"text":"-"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":73},"end":{"row":83,"column":74}},"text":"*"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":39},"end":{"row":85,"column":40}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":40},"end":{"row":85,"column":41}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":41},"end":{"row":85,"column":42}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":42},"end":{"row":85,"column":43}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":43},"end":{"row":85,"column":45}},"text":"处理"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":45},"end":{"row":85,"column":46}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":46},"end":{"row":85,"column":47}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":47},"end":{"row":85,"column":48}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":48},"end":{"row":85,"column":49}},"text":"k"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":49},"end":{"row":85,"column":50}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":50},"end":{"row":85,"column":51}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":51},"end":{"row":85,"column":52}},"text":"z"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":52},"end":{"row":85,"column":53}},"text":"h"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":53},"end":{"row":85,"column":54}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":54},"end":{"row":85,"column":55}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":55},"end":{"row":85,"column":56}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":85,"column":55},"end":{"row":85,"column":56}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":85,"column":54},"end":{"row":85,"column":55}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":85,"column":53},"end":{"row":85,"column":54}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":85,"column":52},"end":{"row":85,"column":53}},"text":"h"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":85,"column":51},"end":{"row":85,"column":52}},"text":"z"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":51},"end":{"row":85,"column":52}},"text":"中"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":52},"end":{"row":85,"column":53}},"text":"德"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":85,"column":52},"end":{"row":85,"column":53}},"text":"德"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":52},"end":{"row":85,"column":53}},"text":"的"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":53},"end":{"row":85,"column":54}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":54},"end":{"row":85,"column":55}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":55},"end":{"row":85,"column":56}},"text":"m"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":56},"end":{"row":85,"column":57}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":57},"end":{"row":85,"column":58}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":58},"end":{"row":85,"column":59}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":59},"end":{"row":85,"column":61}},"text":"含有"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":61},"end":{"row":85,"column":62}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":62},"end":{"row":85,"column":63}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":63},"end":{"row":85,"column":64}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":64},"end":{"row":85,"column":65}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":65},"end":{"row":85,"column":66}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":66},"end":{"row":85,"column":67}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":67},"end":{"row":85,"column":68}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":68},"end":{"row":85,"column":69}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":69},"end":{"row":85,"column":70}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":85,"column":70},"end":{"row":85,"column":71}},"text":"m"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":138,"column":21},"end":{"row":138,"column":22}},"text":"8"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":138,"column":21},"end":{"row":138,"column":22}},"text":"1"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":138,"column":22},"end":{"row":138,"column":23}},"text":"2"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":139,"column":28},"end":{"row":139,"column":29}},"text":"7"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":139,"column":28},"end":{"row":139,"column":29}},"text":"1"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":139,"column":29},"end":{"row":139,"column":30}},"text":"1"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":181,"column":53},"end":{"row":182,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":182,"column":0},"end":{"row":182,"column":12}},"text":"            "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":195,"column":0},"end":{"row":195,"column":2}},"text":"};"},{"action":"removeLines","range":{"start":{"row":0,"column":0},"end":{"row":195,"column":0}},"nl":"\n","lines":["var https = require(\"https\");","var util = require('util');","var zlib = require('zlib');","","","util.apply = function(o, c, defaults) {","    if (defaults) {","        util.apply(o, defaults);","    }","    if (o && c && typeof c == 'object') {","        for (var p in c) {","            o[p] = c[p];","        }","    }","    return o;","};","","util.apply(String.prototype, {","    contains: function(str) {","        return str && this.indexOf(str) > -1;","    },","    startsWith: function(prefix) {","        return prefix && this.length >= prefix.length && this.substring(0, prefix.length) === prefix;","    },","    endsWith: function(suffix) {","        return suffix && this.length >= suffix.length && this.slice(-suffix.length) === suffix;","    },","    hashCode: function() {","        if (this.length === 0) return 0;","        var hash = 0,","            charAt, i, len = this.length;","        for (i = 0; i < len; i++) {","            charAt = this.charCodeAt(i);","            hash = ((hash << 5) - hash) + charAt;","            hash = hash & hash; // Convert to 32bit integer","        }","        return hash;","    }","});","","var trust_proxy = process.env.trust_proxy === false ? false : true;","","var rulesDefine = {","    html: [{","        \"pathRegex\": /\\/(search|webhp)/,","        \"pattern\": /onmousedown=\\\"[^\\\"]+?\\\"/g,","        \"replacement\": \"target=\\\"_blank\\\"\"","        /* 换掉 /search rwt */","    }, {","        \"pattern\": /,pushdown_promo:'[^']+?'/g,","        \"replacement\": \"\"","        /* 滤掉广告 */","    }, {","        \"pattern\": /\\/\\/(?=ssl\\.)/g,","        \"replacement\": \"/!\"","        /* 重写绝对地址 */","    }, {","        \"pattern\": /(\\w+:)?\\/\\/www\\.google[.\\w]+/g,","        \"replacement\": \"\"","        /* 重写绝对地址 */","    }],","    js: [{","        \"pattern\": /(\\w+:)?\\/\\/www\\.google[.\\w]+/g,","        \"replacement\": \"\"","        /* 重写xjs,rs绝对地址 */","    }],","    json: [{","        \"pattern\": /https:\\\\\\/\\\\\\/www\\.google[.\\w]+/g,","        \"replacement\": \"\"","    }, {","        \"pattern\": /onmousedown\\\\\\\\x3d\\\\\\\\x22.+?\\\\\\\\x22/g,","        \"replacement\": \"target\\\\\\\\x3d\\\\\\\\x22_blank\\\\\\\\x22\"","    }]","};","","var reCookieDomain = /;\\s*domain=\\.google[.\\w]+/;","","https.globalAgent.maxSockets = 65535;","","","function copyHeaders(src, dest) {","    var _dest = dest || {};","    for (var key in src) {","        if (key != 'host' && !key.startsWith('x-')) {   // 防止x-forwarded-*","            var val = src[key];","            if (key === 'set-cookie') { // 处理cookie中的domain含有google.com","                if (util.isArray(val)) {","                    for (var i = 0, len = val.length; i < len; i++) {","                        val[i] = val[i].replace(reCookieDomain, '');","                    }","                } else {","                    val = val.replace(reCookieDomain, '');","                }","            }","            _dest[key] = val;","        }","    }","    if (!dest) return _dest;","}","","function processContent(obj) {","    var rules, contentType = obj.contentType || '';","    if (contentType.contains('html')) {","        rules = rulesDefine.html;","    } else if (contentType.contains('javas')) {","        rules = rulesDefine.js;","    } else if (contentType.contains('json')) {","        rules = rulesDefine.json;","    }","    if (rules) {","        var str = obj.content.toString();","        for (var rule, i = 0, len = rules.length; i < len; i++) {","            rule = rules[i];","            if (rule.pathRegex && !rule.pathRegex.test(obj.path)) continue;","            str = str.replace(rule.pattern, rule.replacement);","        }","        return new Buffer(str);","    }","    return obj.content;","}","","function buildReuqest(req) {","    var path = req.url,","        options = {","            hostname: 'www.google.com',","            path: path","        };","    if (path.startsWith('/!')) {","        var sp = path.indexOf('/', 1);","        options.hostname = path.substring(2, sp);","        options.path = path.substr(sp);","    }","    options.headers = copyHeaders(req.headers);","    return options;","}","","function log(msg, req) {","    var client = req ? ((trust_proxy && req.headers['x-forwarded-for']) || req.connection.remoteAddress) : '*';","    if (msg.length > 120) {","        msg = msg.substr(0, 117) + '...';","    }","    util.log(client + ' - ' + msg);","}","","/**"," * 请求会话"," */","function GSession(req) {","    this.req = req;","    this.path = req.url;","}","","util.apply(GSession.prototype, {","","    sendHeaders: function(response) {","        this.proxyContentType = response.headers['content-type'];","        this.res.setHeader('Content-Encoding', 'deflate');","        var headers = copyHeaders(response.headers);","        this.res.writeHead(response.statusCode, headers);","    },","","    sendBody: function() {","        if (this.proxyContentType) {","            this.body = processContent({","                path: this.path,","                contentType: this.proxyContentType,","                content: this.body","            });","        }","        zlib.deflateRaw(this.body, function(err, buf) {","            this.res.write(buf);","            this.res.end();","        }.bind(this));","    },","","    doProxy: function(res) {","        this.res = res;","        https.request(buildReuqest(this.req), function(pxRes) {","            log(util.format('[%s] < %s', pxRes.statusCode, this.path), this.req);","            this.sendHeaders(pxRes);","            this.body = new Buffer(0);","            pxRes.on('end', this.sendBody.bind(this))","            .on('data', function(data) {","                this.body = Buffer.concat([this.body, data]);","            }.bind(this));","        }.bind(this)).on('error', function(e) {","            res.writeHead(e.statusCode, e.message);","            res.end();","        }).end();","    }","});","","","module.exports = function(req, res) {","    new GSession(req).doProxy(res);"]},{"action":"insertText","range":{"start":{"row":0,"column":0},"end":{"row":0,"column":29}},"text":"var https = require(\"https\");"},{"action":"insertText","range":{"start":{"row":0,"column":29},"end":{"row":1,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1,"column":0},"end":{"row":194,"column":0}},"lines":["var util = require('util');","var zlib = require('zlib');","","","util.apply = function(o, c, defaults) {","    if (defaults) {","        util.apply(o, defaults);","    }","    if (o && c && typeof c == 'object') {","        for (var p in c) {","            o[p] = c[p];","        }","    }","    return o;","};","","util.apply(String.prototype, {","    contains: function(str) {","        return str && this.indexOf(str) > -1;","    },","    startsWith: function(prefix) {","        return prefix && this.length >= prefix.length && this.substring(0, prefix.length) === prefix;","    },","    endsWith: function(suffix) {","        return suffix && this.length >= suffix.length && this.slice(-suffix.length) === suffix;","    },","    hashCode: function() {","        if (this.length === 0) return 0;","        var hash = 0,","            charAt, i, len = this.length;","        for (i = 0; i < len; i++) {","            charAt = this.charCodeAt(i);","            hash = ((hash << 5) - hash) + charAt;","            hash = hash & hash; // Convert to 32bit integer","        }","        return hash;","    }","});","","var trust_proxy = process.env.trust_proxy === false ? false : true;","","var rulesDefine = {","    html: [{","        \"pathRegex\": /\\/(search|webhp)/,","        \"pattern\": /onmousedown=\\\"[^\\\"]+?\\\"/g,","        \"replacement\": \"target=\\\"_blank\\\"\"","        /* 换掉 /search rwt */","    }, {","        \"pattern\": /,pushdown_promo:'[^']+?'/g,","        \"replacement\": \"\"","        /* 滤掉广告 */","    }, {","        \"pattern\": /\\/\\/(?=ssl\\.)/g,","        \"replacement\": \"/!\"","        /* 重写绝对地址 */","    }, {","        \"pattern\": /(\\w+:)?\\/\\/www\\.google[.\\w]+/g,","        \"replacement\": \"\"","        /* 重写绝对地址 */","    }],","    js: [{","        \"pattern\": /(\\w+:)?\\/\\/www\\.google[.\\w]+/g,","        \"replacement\": \"\"","        /* 重写xjs,rs绝对地址 */","    }],","    json: [{","        \"pattern\": /https:\\\\\\/\\\\\\/www\\.google[.\\w]+/g,","        \"replacement\": \"\"","    }, {","        \"pattern\": /onmousedown\\\\\\\\x3d\\\\\\\\x22.+?\\\\\\\\x22/g,","        \"replacement\": \"target\\\\\\\\x3d\\\\\\\\x22_blank\\\\\\\\x22\"","    }]","};","","var reCookieDomain = /;\\s*domain=\\.google[.\\w]+/;","","https.globalAgent.maxSockets = 65535;","","","function copyHeaders(src, dest) {","    var _dest = dest || {};","    for (var key in src) {","        if (key != 'host' && !key.startsWith('x-')) { // 防止x-forwarded-*","            var val = src[key];","            if (key === 'set-cookie') { // 处理cookie中的domain含有google.com","                if (util.isArray(val)) {","                    for (var i = 0, len = val.length; i < len; i++) {","                        val[i] = val[i].replace(reCookieDomain, '');","                    }","                } else {","                    val = val.replace(reCookieDomain, '');","                }","            }","            _dest[key] = val;","        }","    }","    if (!dest) return _dest;","}","","function processContent(obj) {","    var rules, contentType = obj.contentType || '';","    if (contentType.contains('html')) {","        rules = rulesDefine.html;","    } else if (contentType.contains('javas')) {","        rules = rulesDefine.js;","    } else if (contentType.contains('json')) {","        rules = rulesDefine.json;","    }","    if (rules) {","        var str = obj.content.toString();","        for (var rule, i = 0, len = rules.length; i < len; i++) {","            rule = rules[i];","            if (rule.pathRegex && !rule.pathRegex.test(obj.path)) continue;","            str = str.replace(rule.pattern, rule.replacement);","        }","        return new Buffer(str);","    }","    return obj.content;","}","","function buildReuqest(req) {","    var path = req.url,","        options = {","            hostname: 'www.google.com',","            path: path","        };","    if (path.startsWith('/!')) {","        var sp = path.indexOf('/', 1);","        options.hostname = path.substring(2, sp);","        options.path = path.substr(sp);","    }","    options.headers = copyHeaders(req.headers);","    return options;","}","","function log(msg, req) {","    var client = req ? ((trust_proxy && req.headers['x-forwarded-for']) || req.connection.remoteAddress) : '*';","    if (msg.length > 120) {","        msg = msg.substr(0, 117) + '...';","    }","    util.log(client + ' - ' + msg);","}","","/**"," * 请求会话"," */","function GSession(req) {","    this.req = req;","    this.path = req.url;","}","","util.apply(GSession.prototype, {","","    sendHeaders: function(response) {","        this.proxyContentType = response.headers['content-type'];","        this.res.setHeader('Content-Encoding', 'deflate');","        var headers = copyHeaders(response.headers);","        this.res.writeHead(response.statusCode, headers);","    },","","    sendBody: function() {","        if (this.proxyContentType) {","            this.body = processContent({","                path: this.path,","                contentType: this.proxyContentType,","                content: this.body","            });","        }","        zlib.deflateRaw(this.body, function(err, buf) {","            this.res.write(buf);","            this.res.end();","        }.bind(this));","    },","","    doProxy: function(res) {","        this.res = res;","        https.request(buildReuqest(this.req), function(pxRes) {","            log(util.format('[%s] < %s', pxRes.statusCode, this.path), this.req);","            this.sendHeaders(pxRes);","            this.body = new Buffer(0);","            pxRes.on('end', this.sendBody.bind(this)).on('data', function(data) {","                this.body = Buffer.concat([this.body, data]);","            }.bind(this));","        }.bind(this)).on('error', function(e) {","            res.writeHead(e.statusCode, e.message);","            res.end();","        }).end();","    }","});","","","module.exports = function(req, res) {","    new GSession(req).doProxy(res);"]},{"action":"insertText","range":{"start":{"row":194,"column":0},"end":{"row":194,"column":2}},"text":"};"}]}]]},"ace":{"folds":[],"scrolltop":2832.5,"scrollleft":0,"selection":{"start":{"row":115,"column":9},"end":{"row":115,"column":9},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":176,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1407589411914,"hash":"0ad8be14c7601335de0d335af0d1b40581e7b712"}